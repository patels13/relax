function fixShortcut(name){return name=isMac?name.replace("Ctrl","Cmd"):name.replace("Cmd","Ctrl")}function createIcon(name,options){options=options||{};var el=document.createElement("a"),shortcut=options.shortcut||shortcuts[name];return shortcut&&(shortcut=fixShortcut(shortcut),el.title=shortcut,el.title=el.title.replace("Cmd","⌘"),isMac&&(el.title=el.title.replace("Alt","⌥"))),el.className=options.className||"icon-"+name,el}function createSep(){return el=document.createElement("i"),el.className="separator",el.innerHTML="|",el}function getState(cm,pos){pos=pos||cm.getCursor("start");var stat=cm.getTokenAt(pos);if(!stat.type)return{};for(var data,text,types=stat.type.split(" "),ret={},i=0;i<types.length;i++)data=types[i],"strong"===data?ret.bold=!0:"variable-2"===data?(text=cm.getLine(pos.line),/^\s*\d+\.\s/.test(text)?ret["ordered-list"]=!0:ret["unordered-list"]=!0):"atom"===data?ret.quote=!0:"em"===data&&(ret.italic=!0);return ret}function toggleFullScreen(editor){var el=editor.codemirror.getWrapperElement(),doc=document,isFull=doc.fullScreen||doc.mozFullScreen||doc.webkitFullScreen,request=function(){el.requestFullScreen?el.requestFullScreen():el.mozRequestFullScreen?el.mozRequestFullScreen():el.webkitRequestFullScreen&&el.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)},cancel=function(){doc.cancelFullScreen?doc.cancelFullScreen():doc.mozCancelFullScreen?doc.mozCancelFullScreen():doc.webkitCancelFullScreen&&doc.webkitCancelFullScreen()};isFull?cancel&&cancel():request()}function toggleBold(editor){var text,cm=editor.codemirror,stat=getState(cm),start="**",end="**",startPoint=cm.getCursor("start"),endPoint=cm.getCursor("end");stat.bold?(text=cm.getLine(startPoint.line),start=text.slice(0,startPoint.ch),end=text.slice(startPoint.ch),start=start.replace(/^(.*)?(\*|\_){2}(\S+.*)?$/,"$1$3"),end=end.replace(/^(.*\S+)?(\*|\_){2}(\s+.*)?$/,"$1$3"),startPoint.ch-=2,endPoint.ch-=2,cm.setLine(startPoint.line,start+end)):(text=cm.getSelection(),cm.replaceSelection(start+text+end),startPoint.ch+=2,endPoint.ch+=2),cm.setSelection(startPoint,endPoint),cm.focus()}function toggleItalic(editor){var text,cm=editor.codemirror,stat=getState(cm),start="*",end="*",startPoint=cm.getCursor("start"),endPoint=cm.getCursor("end");stat.italic?(text=cm.getLine(startPoint.line),start=text.slice(0,startPoint.ch),end=text.slice(startPoint.ch),start=start.replace(/^(.*)?(\*|\_)(\S+.*)?$/,"$1$3"),end=end.replace(/^(.*\S+)?(\*|\_)(\s+.*)?$/,"$1$3"),startPoint.ch-=1,endPoint.ch-=1,cm.setLine(startPoint.line,start+end)):(text=cm.getSelection(),cm.replaceSelection(start+text+end),startPoint.ch+=1,endPoint.ch+=1),cm.setSelection(startPoint,endPoint),cm.focus()}function toggleBlockquote(editor){var cm=editor.codemirror;_toggleLine(cm,"quote")}function toggleUnOrderedList(editor){var cm=editor.codemirror;_toggleLine(cm,"unordered-list")}function toggleOrderedList(editor){var cm=editor.codemirror;_toggleLine(cm,"ordered-list")}function drawLink(editor){var cm=editor.codemirror,stat=getState(cm);_replaceSelection(cm,stat.link,"[","](http://)")}function drawImage(editor){var cm=editor.codemirror,stat=getState(cm);_replaceSelection(cm,stat.image,"![","](http://)")}function undo(editor){var cm=editor.codemirror;cm.undo(),cm.focus()}function redo(editor){var cm=editor.codemirror;cm.redo(),cm.focus()}function togglePreview(editor){var toolbar=editor.toolbar.preview,parse=editor.constructor.markdown,cm=editor.codemirror,wrapper=cm.getWrapperElement(),preview=wrapper.lastChild;/editor-preview/.test(preview.className)||(preview=document.createElement("div"),preview.className="editor-preview",wrapper.appendChild(preview)),/editor-preview-active/.test(preview.className)?(preview.className=preview.className.replace(/\s*editor-preview-active\s*/g,""),toolbar.className=toolbar.className.replace(/\s*active\s*/g,"")):(setTimeout(function(){preview.className+=" editor-preview-active"},1),toolbar.className+=" active");var text=cm.getValue();preview.innerHTML=parse(text)}function _replaceSelection(cm,active,start,end){var text,startPoint=cm.getCursor("start"),endPoint=cm.getCursor("end");active?(text=cm.getLine(startPoint.line),start=text.slice(0,startPoint.ch),end=text.slice(startPoint.ch),cm.setLine(startPoint.line,start+end)):(text=cm.getSelection(),cm.replaceSelection(start+text+end),startPoint.ch+=start.length,endPoint.ch+=start.length),cm.setSelection(startPoint,endPoint),cm.focus()}function _toggleLine(cm,name){for(var stat=getState(cm),startPoint=cm.getCursor("start"),endPoint=cm.getCursor("end"),repl={quote:/^(\s*)\>\s+/,"unordered-list":/^(\s*)(\*|\-|\+)\s+/,"ordered-list":/^(\s*)\d+\.\s+/},map={quote:"> ","unordered-list":"* ","ordered-list":"1. "},i=startPoint.line;i<=endPoint.line;i++)!function(i){var text=cm.getLine(i);text=stat[name]?text.replace(repl[name],"$1"):map[name]+text,cm.setLine(i,text)}(i);cm.focus()}function wordCount(data){var pattern=/[a-zA-Z0-9_\u0392-\u03c9]+|[\u4E00-\u9FFF\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\uac00-\ud7af]+/g,m=data.match(pattern),count=0;if(null===m)return count;for(var i=0;i<m.length;i++)count+=m[i].charCodeAt(0)>=19968?m[i].length:1;return count}var isMac=/Mac/.test(navigator.platform),shortcuts={"Cmd-B":toggleBold,"Cmd-I":toggleItalic,"Cmd-K":drawLink,"Cmd-Alt-I":drawImage,"Cmd-'":toggleBlockquote,"Cmd-Alt-L":toggleOrderedList,"Cmd-L":toggleUnOrderedList};